<div class="bg-image"></div>

<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" color="light"></ion-back-button>
    </ion-buttons>
    <ion-title>Generar Reportes</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="transparent-content">

  <div class="report-container">
    
    <div class="section-card filtros-card">
      <div class="card-header">
        <ion-icon name="filter-outline"></ion-icon>
        <h3>Filtros de Búsqueda</h3>
      </div>

      <div class="card-body">
        <div class="input-wrapper">
          <label>Pozo a consultar</label>
          <div class="input-container">
             <ion-item lines="none" class="transparent-item">
                <ion-icon name="water-outline" slot="start"></ion-icon>
                <ion-select placeholder="Todos los pozos" [(ngModel)]="filtroPozo" interface="popover">
                  <ion-select-option value="todos">Todos los pozos</ion-select-option>
                  <ion-select-option *ngFor="let pozo of pozosDelUsuario" [value]="pozo.nombre">
                    {{ pozo.nombre }}
                  </ion-select-option>
                </ion-select>
             </ion-item>
          </div>
        </div>

        <ion-grid class="ion-no-padding">
          <ion-row>
            <ion-col size="6" class="ion-padding-end">
               <div class="input-wrapper">
                 <label>Desde</label>
                 <div class="input-container date-input">
                    <ion-item lines="none" class="transparent-item">
                       <ion-input type="date" [(ngModel)]="filtroFechaInicio" [max]="todayString"></ion-input>
                    </ion-item>
                 </div>
               </div>
            </ion-col>
            <ion-col size="6" class="ion-padding-start">
               <div class="input-wrapper">
                 <label>Hasta</label>
                 <div class="input-container date-input">
                    <ion-item lines="none" class="transparent-item">
                       <ion-input type="date" [(ngModel)]="filtroFechaFin" [max]="todayString"></ion-input>
                    </ion-item>
                 </div>
               </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <ion-button expand="block" class="generate-btn" (click)="generarReporte()">
           <span *ngIf="!loading">GENERAR REPORTE</span>
           <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
        </ion-button>
      </div>
    </div>

    <div class="segment-wrapper">
      <ion-segment [(ngModel)]="selectedSegment" mode="ios">
        <ion-segment-button value="mediciones">
          <ion-label>Mediciones</ion-label>
        </ion-segment-button>
        <ion-segment-button value="alertas">
          <ion-label>Alertas</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>


    <div *ngIf="selectedSegment === 'mediciones'" class="results-area">
      
      <div *ngIf="busquedaRealizada">
        
        <div *ngIf="historialMediciones.length > 0">
          <div class="results-header">
             <h4>Historial Encontrado</h4>
             <ion-button size="small" class="pdf-btn" (click)="descargarPDF()">
               <ion-icon slot="start" name="download-outline"></ion-icon>
               PDF
             </ion-button>
          </div>

          <div class="result-card" *ngFor="let item of historialMediciones">
             <div class="result-icon blue">
                <ion-icon name="analytics"></ion-icon>
             </div>
             <div class="result-info">
                <h5>{{ item.pozo }}</h5>
                <span class="date-badge">{{ item.fecha | date:'dd/MM/yyyy' }}</span>
                <p>Vida Útil: <b>{{ item.vidaUtil }}</b> | Estado: {{ item.estado }}</p>
                <small>Profundidad: {{ item.profundidad }}</small>
             </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="historialMediciones.length === 0 && !loading">
           <ion-icon name="search-outline"></ion-icon>
           <p>No hay mediciones en este rango.</p>
        </div>

      </div>
    </div>


    <div *ngIf="selectedSegment === 'alertas'" class="results-area">
      
      <div *ngIf="busquedaRealizada">

        <div *ngIf="pozosEnAlerta.length > 0">
           <div class="results-header">
             <h4>Pozos en Alerta</h4>
             <ion-button size="small" class="pdf-btn" (click)="descargarAlertasPDF()">
               <ion-icon slot="start" name="download-outline"></ion-icon>
               PDF
             </ion-button>
           </div>

           <div class="result-card alert-mode" *ngFor="let pozo of pozosEnAlerta">
              <div class="result-icon">
                 <ion-icon name="warning" color="dark"></ion-icon>
              </div>
              
              <div class="result-info">
                 <h5>{{ pozo.nombre }}</h5>
                 
                 <span class="status-badge" 
                       [ngClass]="{
                          'critico': getEstado(pozo)?.toLowerCase() === 'bajo' || getEstado(pozo)?.toLowerCase() === 'critico', 
                          'medio': getEstado(pozo)?.toLowerCase() === 'medio'
                       }">
                   {{ getTextoEstado(getEstado(pozo)) }}
                 </span>

                 <p>Vida Restante: <b>{{ pozo.vidaUtilRestante }}%</b></p>
                 <small>Instalado: {{ pozo.fechaInstalacion | date:'dd/MM/yyyy' }}</small>
              </div>
           </div>
        </div>

        <div class="empty-state success" *ngIf="pozosEnAlerta.length === 0 && !loading">
           <ion-icon name="checkmark-circle-outline"></ion-icon>
           <p>Todo excelente. No hay alertas para esta búsqueda.</p>
        </div>

      </div>
    </div>

  </div>
</ion-content>